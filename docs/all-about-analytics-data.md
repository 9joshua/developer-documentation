---
category: Develop
---
# All About Analytics Data

## About this guide

**Read this guide if**

* you'd like to know **how to aggregate, store and serve new analytics data with your plugin**
* you'd like to know **what the Archiving Process is and how it is used to automatically aggregate and cache analytics data**
* you'd like to know **how analytics data is stored and manipulated in PHP**
* you'd like to know **what segments are and how you can define your own**

## About Analytics

Analyzing data means searching for patterns in a set of _**things**_. In Piwik those **_things_** are visits, web actions and goal conversions.

We search for patterns by [**reducing**](http://en.wikipedia.org/wiki/Data_reduction) the set of things. Or in other words, we search for patterns by grouping individual things together to create subsets that are both recognizable and meaningful.

In Piwik the result of that grouping is the **analytics data**. Analytics data is stored, displayed and exposed through an API. Read on to learn what this data contains, how Piwik calculates and stores it, and how it is made available to Piwik users.

## Analytics Reports & Metrics

Piwik aggregates and persists two types of analytics data:

- **metrics**, which are single numeric values
- **reports**, which are two-dimensional array of values

Reports will normally contain metric values, but they can also contain other data (either additionally or in lieu of metric values).

Reports and metrics are defined by plugins, letting any plugin extend the data analyzed by Piwik. However there are several metrics, called **core metrics**, that are defined by **Piwik Core**.

### Core metrics

**Core metrics** are metrics that are not defined by plugins but by **Piwik Core**.

New reports that analyze visits, action types or conversions should contain these metrics.

#### Visit metrics

Core metrics for a set of visits:

Name             | Metric ID             | Description
-----------------|-----------------------|------------
Visits           | `nb_visits`           | Number of tracked visits. <br> A visit is series of events each of which happened no more than 30 minutes apart.
Unique visitors  | `nb_uniq_visitors`    | The number of unique sources of visits. <br> A visit source is an entity that causes a visit to be tracked.
Actions          | `nb_actions`          | The number of tracked actions. <br> An action is an event tracked by Piwik.
Max Actions      | `max_actions`         | The maximum number of actions that occurred in one visit.
Sum Visit Length | `sum_visit_length`    | The sum of each visit's elapsed time.
Bounce Count     | `bounce_count`        | The number of visits that consisted of only one action.
Converted Visits | `nb_visits_converted` | The number of visits that caused at least one conversion. <br> Includes conversions for every goal of a site.
Conversions      | `nb_conversions`      | The number of conversions tracked for this set of visits. <br> Includes conversions for every goal of a site.
Revenue          | `revenue`             | The total revenue generated by these visits. <br> Includes revenue for every goal of a site plus its ecommerce revenue.

#### Action metrics

Core metrics for a single action type:

Name                      | Metric ID                      | Description
--------------------------|--------------------------------|------------
Hits                      | `nb_hits`                      | The number times this action was ever done.
Sum Time Spent            | `sum_time_spent`               | The total amount of time the user spent doing this action.
Sum Page Generation Time  | `sum_time_generation`          | The total amount of time a server spent serving this action.
Hits With Generation Time | `nb_hits_with_time_generation` | The number of hits that included generation time information.
Min Page Generation Time  | `min_time_generation`          | The minimum amount of time a server spent serving this action.
Max Page Generation Time  | `max_time_generation`          | The maximum amount of time a server spent serving this action.
Unique Exit Visitors      | `exit_nb_uniq_visitors`        | The number of unique visitors that ever exited a site after this action.
Exit Visits               | `exit_nb_visits`               | The total number of visits that ended with this action.
Unique Entry Visitors     | `entry_nb_uniq_visitors`       | The total number of unique visitors that started a visit with this action.
Entry Visits              | `entry_nb_visits`              | The total number of visits that started with this action.
Entry Actions             | `entry_nb_actions`             | <!-- TODO: isn't this the same as entry visits? -->
Entry Sum Visit Length    | `entry_sum_visit_length`       | The sum of each entry visit's elapsed time.
Entry Bounce Count        | `entry_bounce_count`           | The number of visits that consisted of this action and no other.
Hits From Search          | `nb_hits_following_search`     | The number of times this action was done after a site search.

#### E-commerce metrics

Core metrics for the set of ecommerce conversions (either all orders or all abandoned carts) recorded for a set of visits:

Name                 | Metric ID          | Description
---------------------|--------------------|------------
Revenue Subtotal     | `revenue_subtotal` | The total cost of every item that was a part of these orders or abandoned carts.
Revenue Tax          | `revenue_tax`      | The total tax amount applied to these orders/abandoned carts.
Revenue Shipping     | `revenue_shipping` | The total amount of shipping applied to these orders/abandoned carts.
Revenue Discount     | `revenue_discount` | The total amount of discounts applied to these orders/abandoned carts.
Ecommerce Item Count | `items`            | The total number of items in these orders/abandoned carts.

#### Goal metrics

Core metrics for a set of visits and one goal of a site:

Name             | Metric ID                      | Description
-----------------|--------------------------------|------------
Goal Conversions | `goal_<idGoal>_nb_conversions` | The conversions tracked for a specific goal and this set of visits.
Goal Revenue     | `goal_<idGoal>_revenue`        | The total revenue generated by the conversions for a specific goal.

_Note: `<idGoal>` should be replaced with the ID of a goal._

Goal specific metrics are stored in the database in the `goals` column of serialized reports. The column contains a PHP array mapping goal IDs with arrays of goal specific metric values. These values are set as normal column values with the metric names described above by the [AddColumnsProcessedMetricsGoal](/api-reference/Piwik/DataTable/Filter/AddColumnsProcessedMetricsGoal) DataTable filter.

#### Processed metrics

In the interests of [archiving](/guides/all-about-analytics-data#the-archiving-process) and database size efficiency, some metrics are not stored in database. They are instead calculated when needed using other metrics. These metrics are called **processed metrics**.

Below is the list of processed metrics that are calculated using *core metrics*. New reports that analyze visits, action types or conversions should be have these metrics added when possible.

_Note: Some processed metrics will appear multiple times in the lists below. These metrics have different meanings based on the reports they are in._

Processed metrics for a set of visits:

Name                 | Metric ID              | Description
---------------------|------------------------|------------
Conversion Rate      | `conversion_rate`      | The percent of visits that had at least one conversion.
Actions Per Visit    | `nb_actions_per_visit` | The average number of actions for a single visit.
Average Time On Site | `avg_time_on_site`     | The average number of time spent per visit in seconds.
Bounce Rate          | `bounce_rate`          | The percent of visits that resulted in a bounce.

Processed metrics for a single action type:

Name                                         | Metric ID             | Description
---------------------------------------------|-----------------------|------------
Average Generation Time                      | `avg_time_generation` | The average amount of time it took for a server to serve this action.
Average Number of Search Result Pages Viewed | `nb_pages_per_search` | The average number of search result pages viewed after a site search. <br> Only valid for site search keywords and site search categories.
Average Time On Page                         | `avg_time_on_page`    | The average amount of time users spent doing this action.
Entry Bounce Rate                            | `bounce_rate`         | The percent of all visits that consisted of this action and no other.
Exit Rate                                    | `exit_rate`           | The percent of all visits that ended with this action.

Processed metrics for the set of ecommerce orders recorded for a set of visits:

Name                  | Metric ID           | Description
----------------------|---------------------|------------
Average Order Revenue | `avg_order_revenue` | The average revenue of each order.

Processed metrics for the set of ecommerce items in a set of orders or abandoned carts:

Name                    | Metric ID         | Description
------------------------|-------------------|------------
Average Price           | `avg_price`       | The average price of each item.
Average Quantity        | `avg_quantity`    | The average number of each item in an order/abandoned cart.
Product Conversion Rate | `conversion_rate` | The percent of orders/abandoned carts that include this item.

**Goal specific metrics**

The following is a list of processed metrics that are also specific to one goal of one site:

Name                      | Metric ID                         | Description
--------------------------|-----------------------------------|------------
Average Revenue per Visit | `goal_<idGoal>_revenue_per_visit` | The average amount of revenue generated per visit for this goal.

#### Naming metrics

Metrics calculated and persisted by plugins **must** be named with the following format: `PluginName_metricName`. For example: `MyPlugin_myFancyMetric`.

Core metrics have special names and do not follow this convention.

### Reports and DataTables

Reports are stored in memory using the [DataTable](/api-reference/Piwik/DataTable) class. A [DataTable](/api-reference/Piwik/DataTable) is an array of rows where each row is an array of columns.

Each row contains metrics that relate to a set of visits, actions, conversions or some other entity. The set is defined and described by a special **label** column. How the column describes the set depends entirely upon the specific report. For example, in the report returned by the **UserSettings.getBrowser** report a row with the label **Firefox** would hold metrics for the set of all visits that used the Firefox browser.

Some reports, like **VisitsSummary.get** will not have a label column. These reports will have only one row that refers to the entire set of entities.

**Row metadata**

In addition to metrics, each row can also contain metadata. This metadata will usually assist the label column in describing the set of things the row represents.

Some metadata have special meanings. For example, metadata with the name `'logo'` is treated as a path to an image that is used to describe the row. This image is displayed alongside rows when reports are displayed in the UI. The **UserSettings.getBrowser** and **UserSettings.getOs** reports use this metadata value to show an icon for each browser and OS.

Metadata with the name `'url'` is treated as a URL that describes the row. The label of the row is linked to this URL when reports are displayed in the UI.

**Subtables**

Reports can be hierarchical. Each row in a report can be attached to another table of data. Any row in those tables can be attached to more tables, and so on ad infinitum. Tables that are attached to rows are called **subtables**.

Subtables provide further analytics for the set of visits that a row represents. For example, the **Actions.getPageUrls** report contains rows that describes a set of page view actions based on the first part of the page's URL. If this part is a directory and not a file, the row may have a subtable that describes that row's set of page view actions based on the second part of the page's URL.

Another example: the **Referrers.getSearchEngines** report contains a row for each search engine that was used in a visit. Each row will have a subtable that describes the keywords that were used with that search engine. The subtable rows will contain metric values for visits that used a specific keyword (determined by the subtable row) with a specific search engine (determined by the parent row).

#### Naming Reports

Reports should be named in the same way as non-core metrics. That is, they should have a name with the following format: `"PluginName_reportName"` where **PluginName** is the name of the plugin and **reportName** is the name of the report. For example: `"MyPlugin_myFancyReport"`.

Plugins that do not follow this convention will cause errors during the [Archiving Process](/guides/all-about-analytics-data#the-archiving-process).

### Analytics Parameters

Reports and metrics provide analytics data about a set of things. Piwik determines what is in this set by using three constraints: a website ID, a period and a segment.

The website ID selects visits that were tracked for a specific website. This ID is specified in all HTTP requests by the **idSite** query parameter.

The period selects visits that were tracked within a specific date range. The period is specified in all HTTP requests by the **date** and **period** query parameters.

The segment selects visits based on a boolean expression that uses visit properties. It is specified in all HTTP requests by the **segment** query parameter and can be used to select almost any conceivable subset of visit.

Analytics parameters are normally stored in reports as report metadata (that is, they are stored as [DataTable](/api-reference/Piwik/DataTable) metadata).

**Every report and metric describes a set of things determined by these three parameters: the website, period and segment.**

## Report & Metric Persistence (Archive Data)

When persisted, reports and metrics are collectively termed **Archive Data**, which simply means that the data has been cached and does not need to be re-calculated.

Persisted reports and metrics are indexed by the website ID, period and segment. The date and time that the data was calculated and cached is also attached to each report and metric. _To learn the specifics of how this is done with MySQL see the [Piwik database schema](/guides/persistence-and-the-mysql-backend)._

### Metric persistence

Metrics are numeric values and so there is nothing special done when persisting them. The website ID, period, segment and datetime of caching are attached to the metric value, and all this information is saved.

### Report persistence

Reports are complex data structures and so there is some extra processing required before they are persisted.

The report's list of rows (an array of [DataTable\Row](/api-reference/Piwik/DataTable/Row) instances) is serialized using PHP's [serialize](http://www.php.net/manual/en/function.serialize.php) function. The string result is then compressed using [gzcompress](http://www.php.net/manual/en/function.gzcompress.php).

Finally, the website ID, period, segment and datetime of caching are attached to the compressed data, and all of this information is then saved.

#### Records

When a report is archived, it is called a **record** not a report. We make a distinction because multiple reports can sometimes be generated from one **record**.

For example, the UserSettings plugin uses one record to hold visits by browser information. This record is used to generate both the **UserSettings.getBrowserVersion** report and the **UserSettings.getBrowser** report. The second report simply processes the first in a way to make a new report. The plugin could have archived both reports, but this would have been a **massive** waste of space, considering the new report would be cached for every website/period/segment combination.

<a name="record-storage-guidelines"></a>

<div markdown="1" class="alert alert-warning">
**Record storage guidelines**

Care must be taken to store as little as possible when persisting records. Make sure to follow the guidelines below before inserting records as archive data:

* **Records should not be stored with string column names.** Instead they should be replaced with integer column IDs (see [Metrics](/api-reference/Piwik/Metrics) for a list of existing ones).
* **Metadata that can be added using existing data should not be stored with reports.** Instead they should be added in API methods when turning records into reports.
</div>

## The Archiving Process

Analytics data is calculated and cached on-demand. When a report for a specific website, period and segment (if any) is requested, Piwik will check if the data has been cached, and if not Piwik will generate and cache it.

Archiving logic (the logic that calculates and caches analytics data) is defined by individual plugins. When archiving is initiated, every report defined by a plugin is archived together, rather than individually.

If no segment is supplied in the data query and data cannot be found, every report of every plugin will be generated and cached all at once. If a segment is supplied, then the reports that belong to the same plugins as the requested data will be generated and cached.

<div markdown="1" class="alert alert-warning">
**Plugin Archivers**

Plugins that want to archive reports and metrics define a class called **Archiver** that extends from [Piwik\Plugin\Archiver](/api-reference/Piwik/Plugin/Archiver). This class will be automatically detected and instantiated by Piwik during the archiving process.
</div>

### Report & Metric Aggregation

Reports and metrics are calculated differently based on the period type.

For day periods, the visits/actions/conversions/etc. (called **log data**) are themselves aggregated.

For other periods, the reports & metrics for the days within the periods are aggregated together. For example, when generating a report for a week period, the report for each day within the week (ie, Monday, Tuesday, Wednesday, etc.) will be queried and then aggregated together. This is far faster than aggregating each individual visit/action/etc. that was tracked during the entire week, but creates the same result. [1](#report-metric-aggregation-footnote-1)

Log data aggregation is handled by the [LogAggregator](/api-reference/Piwik/DataAccess/LogAggregator) class. Archive data aggregation is handled by the [ArchiveProcessor::aggregateDataTableRecords](/api-reference/Piwik/ArchiveProcessor#aggregatedatatablerecords) and [ArchiveProcessor::aggregateNumericMetrics](/api-reference/Piwik/ArchiveProcessor#aggregatenumericmetrics) methods. Plugins can access a [LogAggregator](/api-reference/Piwik/DataAccess/LogAggregator) instance and a [ArchiveProcessor](/api-reference/Piwik/ArchiveProcessor) instance through the [Piwik\Plugin\Archiver](/api-reference/Piwik/Plugin/Archiver) class.

To learn more about how aggregation is accomplished with Piwik's MySQL backend, read the [Piwik database schema](/guides/persistence-and-the-mysql-backend) guide.

<a name="report-metric-aggregation-footnote-1"></a>[1] Because of this technique, we cannot calculate unique visitors for non-day periods without aggregating over all visits within the period.

### Report & Metric Caching

Reports and metrics are persisted using the [ArchiveProcessor](/api-reference/Piwik/ArchiveProcessor) class. Metrics are inserted using the [ArchiveProcessor::insertNumericRecord](/api-reference/Piwik/ArchiveProcessor#insertnumericrecords) method. Reports are first serialized using the [DataTable::getSerialized](/api-reference/Piwik/DataTable#getserialized) method and then inserted using the [ArchiveProcessor::insertBlobRecord](/api-reference/Piwik/ArchiveProcessor#insertblobrecord) method:

```php
$archiveProcessor = // ...

// insert a numeric value
$myFancyMetric = // ... calculate the metric value ...
$archiveProcessor->insertNumericRecord('MyPlugin_myFancyMetric', $myFancyMetric);

// insert a record (with all of its subtables)
$maxRowsInTable = Config::getInstance()->General['datatable_archiving_maximum_rows_standard'];j

$dataTable = // ... build by aggregating visits ...
$serializedData = $dataTable->getSerialized($maxRowsInTable, $maxRowsInSubtable = $maxRowsInTable,
                                            $columnToSortBy = Metrics::INDEX_NB_VISITS);

$archiveProcessor->insertBlobRecords('MyPlugin_myFancyReport', $serializedData);
```

### Pre-archiving with cron

Though data is generated on demand, it would be highly inefficient and create a poor user experience if we relied on it for all users. Any user that receives a significant amount of visits would experience a large delay before being able to view their reports. Piwik solves this problem with a console command that launches the archiving process. The should be executed by cron.

The console command can archive data for every website and for every period except range periods. Reports & metrics for [stored segments](http://piwik.org/docs/segmentation/) will also be archived.

The console command will remember when it was last executed and will only initiate the archiving process for a website if there have been visits since that time.

### Disabling browser initiated archiving

For users that have websites that receive a lot of visits, simply allowing on-demand archiving through the browser will cause undesirable delays. These users can disable browser initiated archiving. [Read the user docs for more info.](http://piwik.org/docs/setup-auto-archiving/)

## Serving Reports

Reports are served through the API classes defined by individual plugins. API methods access persisted **[records](#records)** transform them into presentable reports and serve them through Piwik's [Reporting API](/guides/piwiks-reporting-api) either in HTTP responses or to PHP code (such as [Controller](/api-reference/Piwik/Plugin/Controller) methods).

### Transforming Records into Reports

As stated above, records are not the same as reports. Records are structured primarily to be stored not be read by either humans or other software. Thus API methods cannot simply access persisted data and return it. They must manipulated and made presentable.

<div markdown="1" class="alert alert-warning">
**DataTable Filters**

[DataTable](/api-reference/Piwik/DataTable) instances, which are used to hold reports, are manipulated by either iterating through rows and manually making changes or through the use of DataTable [filters](/api-reference/Piwik/DataTable/BaseFilter). DataTable filters manipulate DataTable instances in some way. There are several predefined ones that allow you to do common things without having to write a lot of code.
</div>

Making a report presentable involves undo-ing the [changes that made it more efficient to store](#record-storage-guidelines). Column names can be changed from integer IDs to string metric names via the [ReplaceColumnNames](/api-reference/Piwik/DataTable/Filter/ReplaceColumnNames) [DataTable](/api-reference/Piwik/DataTable) filter:

```php
$dataTable->filter('ReplaceColumnNames');
```

Metadata and [processed metrics](#processed-metrics) should also be added within API methods. Existing filters (everything in the **core/DataTable/Filter** directory) can be used to perform most of these tasks.

### API processing of reports

When a report is returned from an API method it goes through some extra processing based on what query parameters are set for the request. To see exactly what happens to a report, read the relevant section in our [Piwik's Reporting API](/guides/piwiks-reporting-api) guide.

## Learn more

* To learn **how log data and archive data are stored and processed in MySQL** read about the [Piwik database schema](/guides/persistence-and-the-mysql-backend).
* To learn more about **how reports are served in the Reporting API** read our [Piwik's Reporting API](/guides/piwiks-reporting-api) guide.
* To learn more about **how reports are displayed** read our [Visualizing Report Data](/guides/visualizing-report-data) guide.
